<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>병원기록관리</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap');
        
        /* 기본 스타일 보강 (Tailwind 로드 실패 시 대비) */
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #f0f7ff; 
            margin: 0;
            padding: 0;
        }
        
        /* 모바일 환경 뷰포트 대응 */
        .safe-area-bottom { 
            padding-bottom: calc(env(safe-area-inset-bottom) + 1.5rem); 
        }
        
        .modal-active { overflow: hidden; }
        .glass-effect { background: rgba(240, 247, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        /* line-clamp 제거: 모든 내용이 보이도록 수정 */
        .folder-block {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }

        /* 스크립트 차단 안내 메시지 */
        #js-warning {
            display: none;
            background: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">
    <noscript>
        <div style="background: #fee2e2; color: #b91c1c; padding: 1rem; text-align: center;">
            자바스크립트가 비활성화되어 있습니다. 앱 설정을 확인해주세요.
        </div>
    </noscript>

    <!-- Header -->
    <header class="glass-effect border-b border-blue-100 sticky top-0 z-30 px-4 py-3">
        <div class="flex justify-between items-center max-w-2xl mx-auto w-full">
            <div class="w-10"> <!-- 정렬을 위한 빈 공간 -->
                <button id="backBtn" class="invisible w-10 h-10 flex items-center justify-center rounded-full active:bg-blue-100/50 transition">
                    <i class="fas fa-chevron-left text-blue-600"></i>
                </button>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-blue-900 text-center flex-grow" id="headerTitle">병원기록관리</h1>
            <div class="w-10 flex justify-end">
                <button onclick="toggleExportMenu()" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-blue-100/50 transition text-blue-500">
                    <i class="fas fa-share-nodes text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app" class="flex-grow p-4 max-w-2xl mx-auto w-full pb-32">
        <div class="flex justify-center items-center py-20 text-blue-300">
            <i class="fas fa-spinner fa-spin text-2xl"></i>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 glass-effect border-t border-blue-100 flex z-40 safe-area-bottom px-4">
        <button onclick="switchUser('me')" id="tab-me" class="flex-1 py-3 flex flex-col items-center transition-all duration-300">
            <i class="fas fa-user-circle text-xl mb-1"></i>
            <span class="text-[10px] font-bold">나</span>
        </button>
        <button onclick="switchUser('son')" id="tab-son" class="flex-1 py-3 flex flex-col items-center transition-all duration-300">
            <i class="fas fa-child text-xl mb-1"></i>
            <span class="text-[10px] font-bold">아들</span>
        </button>
    </nav>

    <!-- Floating Action Button -->
    <button id="fab" onclick="handleFabClick()" class="fixed bottom-28 right-6 bg-blue-500 text-white w-14 h-14 rounded-full shadow-lg shadow-blue-200 flex items-center justify-center z-40 active:scale-90 transition-transform">
        <i class="fas fa-plus text-xl"></i>
    </button>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/40 hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[92vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-bold text-slate-800">기록</h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="modalBody" class="space-y-5">
                <!-- Dynamic content -->
            </div>
            <div class="mt-8">
                <button id="saveBtn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-100 active:bg-blue-700 transition">저장하기</button>
            </div>
        </div>
    </div>

    <!-- Export/Import -->
    <div id="exportModal" class="fixed inset-0 bg-slate-900/40 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-blue-900 mb-2">데이터 백업/복원</h3>
            <p class="text-[11px] text-slate-500 mb-4 leading-relaxed">내용을 복사하여 보관하거나, 보관했던 내용을 붙여넣어 복원할 수 있습니다.</p>
            <textarea id="exportTextarea" class="w-full h-56 border border-blue-50 rounded-2xl p-4 text-[10px] mb-4 bg-blue-50/30 font-mono focus:ring-2 focus:ring-blue-200 outline-none resize-none" spellcheck="false"></textarea>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="copyData()" class="bg-blue-600 text-white py-3.5 rounded-xl font-bold text-sm">복사하기</button>
                <button onclick="importData()" class="bg-emerald-500 text-white py-3.5 rounded-xl font-bold text-sm">복원하기</button>
            </div>
            <button onclick="closeExportMenu()" class="w-full mt-4 text-slate-400 text-sm font-medium">닫기</button>
        </div>
    </div>

    <script>
        let currentState = {
            currentUser: 'me',
            currentView: 'folderList',
            selectedFolderId: null,
            data: { me: { folders: [] }, son: { folders: [] } }
        };

        const STORAGE_KEY = 'hospital_records_v3';

        function init() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try { currentState.data = JSON.parse(savedData); } catch(e) { console.error(e); }
            }
            render();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentState.data));
        }

        function switchUser(user) {
            currentState.currentUser = user;
            currentState.currentView = 'folderList';
            currentState.selectedFolderId = null;
            render();
        }

        function openFolder(folderId) {
            currentState.currentView = 'noteList';
            currentState.selectedFolderId = folderId;
            render();
        }

        function goBack() {
            currentState.currentView = 'folderList';
            currentState.selectedFolderId = null;
            render();
        }

        function getLatestDate(folder) {
            if (!folder.notes || folder.notes.length === 0) return '-';
            return [...folder.notes].map(n => n.date).sort().reverse()[0]; 
        }

        function render() {
            const app = document.getElementById('app');
            const backBtn = document.getElementById('backBtn');
            const headerTitle = document.getElementById('headerTitle');
            
            const tabMe = document.getElementById('tab-me');
            const tabSon = document.getElementById('tab-son');
            const activeClass = "text-blue-600 bg-white/60 shadow-inner rounded-2xl";
            const inactiveClass = "text-blue-300";
            
            if (tabMe && tabSon) {
                tabMe.className = `flex-1 py-3 flex flex-col items-center transition-all ${currentState.currentUser === 'me' ? activeClass : inactiveClass}`;
                tabSon.className = `flex-1 py-3 flex flex-col items-center transition-all ${currentState.currentUser === 'son' ? activeClass : inactiveClass}`;
            }

            app.innerHTML = '';
            
            if (currentState.currentView === 'folderList') {
                backBtn.classList.add('invisible');
                headerTitle.innerText = '병원기록관리';
                renderFolderList();
            } else {
                backBtn.classList.remove('invisible');
                backBtn.onclick = goBack;
                const folder = currentState.data[currentState.currentUser].folders.find(f => f.id === currentState.selectedFolderId);
                headerTitle.innerText = folder ? folder.name : '기록';
                renderNoteList();
            }
        }

        function renderFolderList() {
            const app = document.getElementById('app');
            const folders = currentState.data[currentState.currentUser].folders;

            if (folders.length === 0) {
                app.innerHTML = `<div class="py-32 text-center text-blue-200 font-medium"><i class="fas fa-folder-open text-4xl mb-4 block"></i>폴더를 만들어보세요</div>`;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-3 gap-3';

            folders.forEach(folder => {
                const latest = getLatestDate(folder);
                const card = document.createElement('div');
                card.className = 'folder-block bg-white p-3 rounded-2xl shadow-sm border border-blue-50 active:bg-blue-50 transition relative overflow-hidden';
                card.onclick = () => openFolder(folder.id);
                card.innerHTML = `
                    <div class="flex-grow flex flex-col items-center justify-center text-center w-full min-w-0">
                        <div class="font-black text-slate-800 truncate w-full text-base mb-1 px-1">${folder.name}</div>
                        <div class="text-[12px] text-blue-600 font-bold mb-0.5">${latest}</div>
                        <div class="text-sm text-slate-500 font-semibold">${folder.notes.length}개</div>
                    </div>
                    <button onclick="event.stopPropagation(); editFolder('${folder.id}')" class="absolute top-2 right-2 text-slate-200 hover:text-blue-400">
                        <i class="fas fa-cog text-[10px]"></i>
                    </button>
                `;
                grid.appendChild(card);
            });
            app.appendChild(grid);
        }

        function renderNoteList() {
            const app = document.getElementById('app');
            const folder = currentState.data[currentState.currentUser].folders.find(f => f.id === currentState.selectedFolderId);
            
            const sortedNotes = [...(folder?.notes || [])].sort((a, b) => a.date.localeCompare(b.date));

            if (sortedNotes.length === 0) {
                app.innerHTML = `<div class="py-20 text-center text-blue-200 text-sm">기록이 없습니다.</div>`;
                return;
            }

            sortedNotes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'bg-white rounded-[1.5rem] mb-4 shadow-sm border border-blue-50 overflow-hidden active:scale-[0.98] transition';
                noteEl.onclick = () => showNoteModal(note.id);
                noteEl.innerHTML = `
                    <div class="px-5 py-4 border-b border-blue-50 flex justify-between items-center bg-blue-50/20">
                        <!-- 폰트 사이즈 키움: text-[11px] -> text-[13px] -->
                        <div class="text-[13px] font-bold text-blue-600 flex items-center space-x-2">
                            <span>${note.date}</span>
                            <span class="text-blue-100">|</span>
                            <span class="text-slate-700 truncate max-w-[120px]">${note.hospital || '미지정'}</span>
                            <!-- 청구 배지 폰트 사이즈 키움: text-[8px] -> text-[10px] -->
                            <span class="px-2 py-0.5 rounded-full ${note.insurance === 'yes' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-400'} text-[10px]">
                                ${note.insurance === 'yes' ? '청구' : '미청구'}
                            </span>
                        </div>
                        <!-- 금액 폰트 사이즈 키움: text-[11px] -> text-[13px] -->
                        <div class="text-[13px] font-bold text-slate-400">${Number(note.amount || 0).toLocaleString()}원</div>
                    </div>
                    <div class="px-5 py-4 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">${note.content || '기록된 내용이 없습니다.'}</div>
                `;
                app.appendChild(noteEl);
            });
        }

        function handleFabClick() {
            if (currentState.currentView === 'folderList') showFolderModal();
            else showNoteModal();
        }

        function showFolderModal(id = null) {
            const isEdit = id !== null;
            const folder = isEdit ? currentState.data[currentState.currentUser].folders.find(f => f.id === id) : null;
            document.getElementById('modalTitle').innerText = isEdit ? '폴더 수정' : '폴더 만들기';
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div>
                    <label class="block text-[11px] font-bold text-blue-300 uppercase mb-2">폴더 이름</label>
                    <input type="text" id="folderName" class="w-full bg-blue-50/50 border-none rounded-2xl p-4 text-slate-800 outline-none focus:ring-2 focus:ring-blue-200" placeholder="예: 당뇨 관리" value="${isEdit ? folder.name : ''}">
                </div>
                ${isEdit ? `<button onclick="deleteFolder('${id}')" class="text-red-400 text-xs font-bold p-2"><i class="fas fa-trash-alt mr-2"></i>폴더 삭제</button>` : ''}
            `;
            document.getElementById('saveBtn').onclick = () => {
                const name = document.getElementById('folderName').value.trim();
                if (!name) return;
                if (isEdit) folder.name = name;
                else currentState.data[currentState.currentUser].folders.push({ id: Date.now().toString(), name, notes: [] });
                saveData(); closeModal(); render();
            };
            openModal();
        }

        function showNoteModal(noteId = null) {
            const isEdit = noteId !== null;
            const folder = currentState.data[currentState.currentUser].folders.find(f => f.id === currentState.selectedFolderId);
            const note = isEdit ? folder.notes.find(n => n.id === noteId) : null;
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('modalTitle').innerText = isEdit ? '기록 수정' : '새 기록';
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-blue-300 mb-1">날짜</label>
                            <input type="date" id="noteDate" class="w-full bg-blue-50/30 border-none rounded-xl p-3 text-xs" value="${isEdit ? note.date : today}">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-blue-300 mb-1">진료비</label>
                            <input type="number" id="noteAmount" class="w-full bg-blue-50/30 border-none rounded-xl p-3 text-xs" placeholder="원" value="${isEdit ? note.amount : ''}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-blue-300 mb-1">병원명</label>
                        <input type="text" id="noteHospital" class="w-full bg-blue-50/30 border-none rounded-xl p-3 text-xs" placeholder="병원 이름" value="${isEdit ? note.hospital : ''}">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-blue-300 mb-1">보험 청구 여부</label>
                        <div class="flex space-x-2">
                            <button onclick="setInsurance('no')" id="ins-no" class="flex-1 py-3 rounded-xl text-xs font-bold border transition">미청구</button>
                            <button onclick="setInsurance('yes')" id="ins-yes" class="flex-1 py-3 rounded-xl text-xs font-bold border transition">청구완료</button>
                        </div>
                        <input type="hidden" id="noteInsurance" value="${isEdit ? note.insurance : 'no'}">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-blue-300 mb-1">상세 내용 (의사 설명 등)</label>
                        <textarea id="noteContent" rows="6" class="w-full bg-blue-50/30 border-none rounded-xl p-4 text-sm leading-relaxed outline-none focus:ring-2 focus:ring-blue-100" placeholder="의사 선생님 말씀을 기록하세요">${isEdit ? note.content : ''}</textarea>
                    </div>
                    ${isEdit ? `<button onclick="deleteNote('${noteId}')" class="text-red-400 text-xs font-bold p-1"><i class="fas fa-trash-alt mr-2"></i>기록 삭제</button>` : ''}
                </div>
            `;
            
            window.setInsurance = (val) => {
                const insuranceInput = document.getElementById('noteInsurance');
                if (insuranceInput) insuranceInput.value = val;
                const btnNo = document.getElementById('ins-no');
                const btnYes = document.getElementById('ins-yes');
                if(!btnNo || !btnYes) return;
                
                if(val === 'yes') {
                    btnYes.className = "flex-1 py-3 rounded-xl text-xs font-bold bg-blue-500 text-white border-blue-500";
                    btnNo.className = "flex-1 py-3 rounded-xl text-xs font-bold bg-white text-slate-400 border-slate-100";
                } else {
                    btnNo.className = "flex-1 py-3 rounded-xl text-xs font-bold bg-slate-500 text-white border-slate-500";
                    btnYes.className = "flex-1 py-3 rounded-xl text-xs font-bold bg-white text-slate-400 border-slate-100";
                }
            };
            setInsurance(document.getElementById('noteInsurance').value);

            document.getElementById('saveBtn').onclick = () => {
                const newData = {
                    id: isEdit ? noteId : Date.now().toString(),
                    date: document.getElementById('noteDate').value,
                    hospital: document.getElementById('noteHospital').value.trim(),
                    insurance: document.getElementById('noteInsurance').value,
                    amount: document.getElementById('noteAmount').value,
                    content: document.getElementById('noteContent').value.trim()
                };
                if (isEdit) {
                    const idx = folder.notes.findIndex(n => n.id === noteId);
                    folder.notes[idx] = newData;
                } else { folder.notes.push(newData); }
                saveData(); closeModal(); render();
            };
            openModal();
        }

        function editFolder(id) { showFolderModal(id); }
        function deleteFolder(id) { if (confirm('폴더와 기록이 모두 삭제됩니다.')) { currentState.data[currentState.currentUser].folders = currentState.data[currentState.currentUser].folders.filter(f => f.id !== id); saveData(); closeModal(); render(); } }
        function deleteNote(noteId) { if (confirm('기록을 삭제하시겠습니까?')) { const folder = currentState.data[currentState.currentUser].folders.find(f => f.id === currentState.selectedFolderId); folder.notes = folder.notes.filter(n => n.id !== noteId); saveData(); closeModal(); render(); } }
        function openModal() { document.getElementById('modal').classList.remove('hidden'); document.body.classList.add('modal-active'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.body.classList.remove('modal-active'); }

        function toggleExportMenu() {
            const modal = document.getElementById('exportModal');
            document.getElementById('exportTextarea').value = JSON.stringify(currentState.data);
            modal.classList.remove('hidden');
        }
        function closeExportMenu() { document.getElementById('exportModal').classList.add('hidden'); }
        function copyData() {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            document.execCommand('copy');
            alert('전체 데이터가 복사되었습니다.');
        }
        function importData() {
            try {
                const newData = JSON.parse(document.getElementById('exportTextarea').value);
                if (newData.me && newData.son) {
                    if (confirm('데이터를 덮어쓰고 복원하시겠습니까?')) {
                        currentState.data = newData;
                        saveData(); alert('복원 완료!'); closeExportMenu(); render();
                    }
                }
            } catch(e) { alert('데이터 형식이 잘못되었습니다.'); }
        }

        window.onload = init;
    </script>
</body>
</html>
